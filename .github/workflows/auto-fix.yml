name: Auto Fix Loop

on:
  push:
    branches: [ main ]

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Lean CLI
        run: pip install --upgrade lean
      - name: Lean Login 
        run: lean login --user-id "386972" --api-token "f6f5df71e9938e3c4eca2298528bcc383c2a5fad14283313ecb9d07c68463e78"
      - name: Update Lean Config
        run: |
          echo "Updating lean.json with organization ID..."
          sed -i 's/"organization-id": ""/"organization-id": "c9d123ffc99a793105570496669ef511"/g' lean.json
          sed -i 's/"job-organization-id": ""/"job-organization-id": "c9d123ffc99a793105570496669ef511"/g' lean.json
          cat lean.json | grep organization-id
      - name: Push Project
        run: lean cloud push --project "IronCondorTest"
      - name: Backtest
        run: lean cloud backtest "IronCondorTest" --open
