name: Auto Fix Loop

on:
  push:
    branches: [ main ]

jobs:
  backtest:
    runs-on: ubuntu-latest
    env:
      QC_TOKEN: ${{ secrets.QC_TOKEN }}
      QC_ORG_ID: ${{ secrets.QC_ORG_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Lean CLI
        run: pip install --upgrade lean
      - name: Lean Login 
        run: lean login -t "$QC_TOKEN" --show-secrets
      - name: Update Lean Config
        run: |
          echo "Updating lean.json with organization ID..."
          sed -i 's/"organization-id": ""/"organization-id": "c9d123ffc99a793105570496669ef511"/g' lean.json
          sed -i 's/"job-organization-id": ""/"job-organization-id": "c9d123ffc99a793105570496669ef511"/g' lean.json
          cat lean.json | grep organization-id
      - name: Push Project
        run: lean cloud push --project "IronCondorTest"
      - name: Backtest
        run: lean cloud backtest "IronCondorTest" --open
