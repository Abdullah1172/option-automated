name: Iron Condor Backtest (Working)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  backtest:
    runs-on: ubuntu-latest
    env:
      QC_TOKEN: ${{ secrets.QC_TOKEN }}
      QC_ORG_ID: ${{ secrets.QC_ORG_ID }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install Lean CLI
        run: pip install --upgrade lean
        
      - name: Verify Secrets
        run: |
          echo "‚úÖ QC_TOKEN length: ${#QC_TOKEN}"
          echo "‚úÖ QC_ORG_ID: $QC_ORG_ID"
          
      - name: Login to QuantConnect
        run: |
          echo "üîë Logging in to QuantConnect..."
          lean login --user-id "386972" --api-token "$QC_TOKEN"
          lean whoami
          echo "‚úÖ Login successful"
          
      - name: Update Lean Config
        run: |
          echo "üìù Updating lean.json with organization ID..."
          sed -i "s/\"organization-id\": \"\"/\"organization-id\": \"$QC_ORG_ID\"/g" lean.json
          sed -i "s/\"job-organization-id\": \"\"/\"job-organization-id\": \"$QC_ORG_ID\"/g" lean.json
          echo "‚úÖ Configuration updated"
          
      - name: Push Project to Cloud
        run: |
          echo "üì¶ Pushing IronCondorTest project..."
          lean cloud push --project "IronCondorTest" --verbose
          echo "‚úÖ Project pushed successfully"
          
      - name: Run Iron Condor Backtest
        timeout-minutes: 60
        run: |
          echo "üöÄ Starting HV-7 Iron Condor backtest (1-hour timeout)..."
          lean cloud backtest "IronCondorTest" --open --verbose